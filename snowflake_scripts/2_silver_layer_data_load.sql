use role sysadmin;
use warehouse transform_wh;

CREATE OR REPLACE DYNAMIC TABLE YELP_DB.SILVER.BUSINESS
TARGET_LAG = 'DOWNSTREAM'
WAREHOUSE = TRANSFORM_WH
REFRESH_MODE = INCREMENTAL
AS
SELECT 
    RAW_DATA:business_id::VARCHAR AS BUSINESS_ID,
    RAW_DATA:name::VARCHAR AS BUSINESS_NAME,
    RAW_DATA:address::VARCHAR AS ADDRESS,
    RAW_DATA:city::VARCHAR AS CITY,
    RAW_DATA:state::VARCHAR AS STATE,
    RAW_DATA:postal_code::VARCHAR AS POSTAL_CODE,
    RAW_DATA:latitude::DECIMAL(10,7) AS LATITUDE,
    RAW_DATA:longitude::DECIMAL(11,7) AS LONGITUDE,
    RAW_DATA:stars::DECIMAL(2,1) AS STARS,
    RAW_DATA:review_count::INTEGER AS REVIEW_COUNT,
    RAW_DATA:is_open::INTEGER = 1 AS IS_OPEN,
    RAW_DATA:attributes AS ATTRIBUTES,
    STRTOK_TO_ARRAY(REGEXP_REPLACE(RAW_DATA:categories, ',\\s*', ','), ',') AS CATEGORIES,
    RAW_DATA:hours AS HOURS,
    _STG_FILE_NAME AS _SOURCE_FILE,
    _COPY_DATA_TS AS _LOADED_AT
FROM YELP_DB.BRONZE.BUSINESS_RAW
WHERE RAW_DATA:business_id IS NOT NULL
  AND RAW_DATA IS NOT NULL;

SELECT * FROM YELP_DB.SILVER.BUSINESS LIMIT 10;

CREATE OR REPLACE DYNAMIC TABLE YELP_DB.SILVER.REVIEW
TARGET_LAG = 'DOWNSTREAM'
WAREHOUSE = TRANSFORM_WH
REFRESH_MODE = INCREMENTAL
AS
SELECT 
    RAW_DATA:review_id::VARCHAR AS REVIEW_ID,
    RAW_DATA:user_id::VARCHAR AS USER_ID,
    RAW_DATA:business_id::VARCHAR AS BUSINESS_ID,
    RAW_DATA:stars::INTEGER AS STARS,
    RAW_DATA:date::DATE AS REVIEW_DATE,
    RAW_DATA:text::VARCHAR AS REVIEW_TEXT,
    LENGTH(RAW_DATA:text::VARCHAR) AS REVIEW_TEXT_LENGTH,
    ARRAY_SIZE(SPLIT(RAW_DATA:text::VARCHAR, ' ')) AS REVIEW_WORD_COUNT,
    COALESCE(RAW_DATA:useful::INTEGER, 0) AS USEFUL_VOTES,
    COALESCE(RAW_DATA:funny::INTEGER, 0) AS FUNNY_VOTES,
    COALESCE(RAW_DATA:cool::INTEGER, 0) AS COOL_VOTES,
    COALESCE(RAW_DATA:useful::INTEGER, 0) + 
    COALESCE(RAW_DATA:funny::INTEGER, 0) + 
    COALESCE(RAW_DATA:cool::INTEGER, 0) AS TOTAL_VOTES,
    (COALESCE(RAW_DATA:useful::INTEGER, 0) + 
     COALESCE(RAW_DATA:funny::INTEGER, 0) + 
     COALESCE(RAW_DATA:cool::INTEGER, 0)) > 0 AS HAS_ENGAGEMENT,
    _STG_FILE_NAME AS _SOURCE_FILE,
    _COPY_DATA_TS AS _LOADED_AT
FROM YELP_DB.BRONZE.REVIEWS_RAW
WHERE RAW_DATA:review_id IS NOT NULL
  AND RAW_DATA IS NOT NULL;

SELECT * FROM YELP_DB.SILVER.REVIEW LIMIT 10;

CREATE OR REPLACE DYNAMIC TABLE YELP_DB.SILVER.USER
TARGET_LAG = 'DOWNSTREAM'
WAREHOUSE = TRANSFORM_WH
REFRESH_MODE = INCREMENTAL
AS
SELECT 
    RAW_DATA:user_id::VARCHAR AS USER_ID,
    RAW_DATA:name::VARCHAR AS USER_NAME,
    RAW_DATA:review_count::INTEGER AS REVIEW_COUNT,
    RAW_DATA:yelping_since::DATE AS YELPING_SINCE,
    COALESCE(RAW_DATA:useful::INTEGER, 0) AS USEFUL_VOTES_SENT,
    COALESCE(RAW_DATA:funny::INTEGER, 0) AS FUNNY_VOTES_SENT,
    COALESCE(RAW_DATA:cool::INTEGER, 0) AS COOL_VOTES_SENT,
    COALESCE(RAW_DATA:fans::INTEGER, 0) AS FANS,
    RAW_DATA:average_stars::DECIMAL(3,2) AS AVERAGE_STARS,
    COALESCE(RAW_DATA:compliment_hot::INTEGER, 0) AS COMPLIMENT_HOT,
    COALESCE(RAW_DATA:compliment_more::INTEGER, 0) AS COMPLIMENT_MORE,
    COALESCE(RAW_DATA:compliment_profile::INTEGER, 0) AS COMPLIMENT_PROFILE,
    COALESCE(RAW_DATA:compliment_cute::INTEGER, 0) AS COMPLIMENT_CUTE,
    COALESCE(RAW_DATA:compliment_list::INTEGER, 0) AS COMPLIMENT_LIST,
    COALESCE(RAW_DATA:compliment_note::INTEGER, 0) AS COMPLIMENT_NOTE,
    COALESCE(RAW_DATA:compliment_plain::INTEGER, 0) AS COMPLIMENT_PLAIN,
    COALESCE(RAW_DATA:compliment_cool::INTEGER, 0) AS COMPLIMENT_COOL,
    COALESCE(RAW_DATA:compliment_funny::INTEGER, 0) AS COMPLIMENT_FUNNY,
    COALESCE(RAW_DATA:compliment_writer::INTEGER, 0) AS COMPLIMENT_WRITER,
    COALESCE(RAW_DATA:compliment_photos::INTEGER, 0) AS COMPLIMENT_PHOTOS,
    COALESCE(RAW_DATA:compliment_hot::INTEGER, 0) +
    COALESCE(RAW_DATA:compliment_more::INTEGER, 0) +
    COALESCE(RAW_DATA:compliment_profile::INTEGER, 0) +
    COALESCE(RAW_DATA:compliment_cute::INTEGER, 0) +
    COALESCE(RAW_DATA:compliment_list::INTEGER, 0) +
    COALESCE(RAW_DATA:compliment_note::INTEGER, 0) +
    COALESCE(RAW_DATA:compliment_plain::INTEGER, 0) +
    COALESCE(RAW_DATA:compliment_cool::INTEGER, 0) +
    COALESCE(RAW_DATA:compliment_funny::INTEGER, 0) +
    COALESCE(RAW_DATA:compliment_writer::INTEGER, 0) +
    COALESCE(RAW_DATA:compliment_photos::INTEGER, 0) AS TOTAL_COMPLIMENTS,
    ARRAY_SIZE(STRTOK_TO_ARRAY(RAW_DATA:friends, ',')) AS FRIEND_COUNT,
    STRTOK_TO_ARRAY(RAW_DATA:elite, ',') AS ELITE_YEARS,
    ARRAY_SIZE(STRTOK_TO_ARRAY(RAW_DATA:elite, ',')) > 0 AS IS_ELITE,
    _STG_FILE_NAME AS _SOURCE_FILE,
    _COPY_DATA_TS AS _LOADED_AT
FROM YELP_DB.BRONZE.USERS_RAW
WHERE RAW_DATA:user_id IS NOT NULL
  AND RAW_DATA IS NOT NULL;

SELECT * FROM YELP_DB.SILVER.USER LIMIT 10;